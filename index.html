<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Tax Evasion</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0;}
html,body{width:100%;height:100%;overflow:hidden;font-family:'Inter',sans-serif;color:#1E3A8A;background-color:#60A5FA;}
#gameCanvas{display:block;background-color:#BFDBFE;position:absolute;top:0;left:0;z-index:1;}
.ui-container{position:absolute;top:0;left:0;width:100%;height:100%;z-index:2;pointer-events:none;display:flex;flex-direction:column;justify-content:space-between;align-items:center;}
#scoreDisplay{font-size:3rem;font-weight:900;margin-top:2rem;text-shadow:0 0 10px rgba(255,255,255,0.3);}
#messageOverlay{font-size:1.5rem;font-weight:700;text-align:center;animation:pulse 2s infinite;}
@keyframes pulse{0%{opacity:1;transform:scale(1);}50%{opacity:0.7;transform:scale(1.05);}100%{opacity:1;transform:scale(1);}}
#gameOverModal{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);z-index:3;background-color:#1F2937;padding:2.5rem;border-radius:1rem;box-shadow:0 10px 30px rgba(0,0,0,0.4);text-align:center;display:none;pointer-events:auto;}
#gameOverModal h1{font-size:2.5rem;font-weight:900;margin-bottom:0.5rem;color:white;}
#gameOverModal p{font-size:1.2rem;margin-bottom:2rem;color:#D1D5DB;}
#restartButton{font-family:'Inter',sans-serif;background:#3B82F6;color:white;border:none;padding:1rem 2rem;border-radius:0.5rem;font-size:1.2rem;font-weight:700;cursor:pointer;transition:all 0.2s ease;box-shadow:0 4px 15px rgba(59,130,246,0.3);}
#restartButton:hover{background:#2563EB;transform:translateY(-2px);}
.touch-zone{position:absolute;top:0;width:50%;height:100%;z-index:1;}
#touchLeft{left:0;}
#touchRight{right:0;}
</style>
</head>
<body>
<canvas id="gameCanvas"></canvas>
<div class="touch-zone" id="touchLeft"></div>
<div class="touch-zone" id="touchRight"></div>
<div class="ui-container">
<div id="scoreDisplay">0</div>
<div id="messageOverlay">Tap Left/Right to Steer<br>Press any key to Start</div>
</div>
<div id="gameOverModal">
<h1>Game Over</h1>
<p>Your final score is: <span id="finalScore">0</span></p>
<p>High Score: <span id="bestScore">0</span></p>
<button id="restartButton">Retry</button>
</div>
<script>
const canvas=document.getElementById('gameCanvas');
const ctx=canvas.getContext('2d');
const scoreDisplay=document.getElementById('scoreDisplay');
const messageOverlay=document.getElementById('messageOverlay');
const gameOverModal=document.getElementById('gameOverModal');
const finalScoreDisplay=document.getElementById('finalScore');
const bestScoreDisplay=document.getElementById('bestScore');
const restartButton=document.getElementById('restartButton');
const touchLeft=document.getElementById('touchLeft');
const touchRight=document.getElementById('touchRight');

let gameState='menu';
let score=0,lastTime=0,gameTime=0;
const camera={x:0,y:0};
const PLAYER_SPEED=150,PLAYER_TURN_SPEED=3.5;
const CAR_WIDTH=20,CAR_HEIGHT=40,CAR_RADIUS=75;
const COP_SPEED=900, COP_TURN_SPEED=1.5;
const MAX_COPS_ON_SCREEN=5;
let spawnTimer=0,spawnInterval=5;

const input={left:false,right:false,fire:false};
let player={},police=[],particles=[],contrails=[],bullets=[];
let lastShotTime=0,SHOT_COOLDOWN=25,BULLET_SPEED=1500,BULLET_RADIUS=5;
let highScore=Number(localStorage.getItem('pp_highscore')||0);

const MINIMAP_SCOPE = 4000;
const COP_SPAWN_INVULNERABILITY = 2.0; // 2 seconds

function resizeCanvas(){canvas.width=window.innerWidth;canvas.height=window.innerHeight;}
function rand(min,max){return Math.random()*(max-min)+min;}
function getDistance(x1,y1,x2,y2){return Math.hypot(x2-x1,y2-y2);}
function wrapAngle(angle){return(angle+Math.PI)%(Math.PI*2)-Math.PI;}
function createCar(x,y,angle,speed,turnSpeed,color,type){return{x,y,angle,speed,turnSpeed,color,type,width:CAR_WIDTH,height:CAR_HEIGHT,radius:CAR_RADIUS,velX:0,velY:0,spawnTime:gameTime};}

function resetGame(){
    // --- THIS WAS THE FIX ---
    // The player must be created at a number, like (0, 0), not a variable that no longer exists.
    player=createCar(0, 0, -Math.PI/2,PLAYER_SPEED,PLAYER_TURN_SPEED,'#3B82F6','player');
    police=[];particles=[];contrails=[];bullets=[];
    score=0;gameTime=0;spawnTimer=2;spawnInterval=5;
    gameState='playing';
    gameOverModal.style.display='none';
    messageOverlay.style.display='none';
    scoreDisplay.style.display='block';
    console.log("Game reset successfully. Player object:", player); // For debugging
}

function spawnPolice(){
if(police.length>=MAX_COPS_ON_SCREEN)return;
const spawnAngle=Math.random()*Math.PI*2;
const spawnDist=Math.max(canvas.width,canvas.height)*0.7;
const x=player.x+Math.cos(spawnAngle)*spawnDist;
const y=player.y+Math.sin(spawnAngle)*spawnDist;
const angle=Math.atan2(player.y-y,player.x-x);
police.push(createCar(x,y,angle,COP_SPEED,COP_TURN_SPEED,'#EF4444','police'));
}

function createExplosion(x,y,count){
for(let i=0;i<count;i++){const angle=Math.random()*Math.PI*2;const speed=rand(50,200);const life=rand(0.5,1.5);particles.push({x,y,dx:Math.cos(angle)*speed,dy:Math.sin(angle)*speed,life,maxLife:life,size:rand(2,5)});}
}

function showGameOver(){
gameState='gameOver';
scoreDisplay.style.display='none';
messageOverlay.style.display='none';
finalScoreDisplay.textContent=score;
if(score>highScore){highScore=score;localStorage.setItem('pp_highscore',highScore);}
bestScoreDisplay.textContent=highScore;
gameOverModal.style.display='block';
}

function drawJet(ctx, entity) {
  ctx.save();
  ctx.translate(entity.x, entity.y);
  ctx.rotate(entity.angle);
  ctx.fillStyle = entity.color;
  
  if (entity.type === 'police' && gameTime - entity.spawnTime < COP_SPAWN_INVULNERABILITY) {
      ctx.globalAlpha = 0.5;
  }

  const w = entity.width * 1.2; 
  const h = entity.height * 1.2;
  ctx.beginPath();
  ctx.moveTo(h / 2, 0); // Nose
  ctx.lineTo(-h / 2, w / 2); // Left wing tip
  ctx.lineTo(-h / 3, 0); // Center-back
  ctx.lineTo(-h / 2, -w / 2); // Right wing tip
  ctx.closePath(); 
  ctx.fill();
  ctx.restore();
}

// --- MAIN UPDATE FUNCTION ---
function update(deltaTime){
if(!deltaTime||isNaN(deltaTime))return;
if(gameState!=='playing')return;

gameTime+=deltaTime;

// --- Player input & drift ---
if(input.left)player.angle-=player.turnSpeed*deltaTime;
if(input.right)player.angle+=player.turnSpeed*deltaTime;
player.velX+=Math.cos(player.angle)*player.speed*deltaTime*0.5;
player.velY+=Math.sin(player.angle)*player.speed*deltaTime*0.5;
player.velX*=0.92;
player.velY*=0.92;
player.x+=player.velX;
player.y+=player.velY;

// --- Contrails ---
contrails.push({x:player.x,y:player.y,angle:player.angle,life:1});
if(contrails.length>300)contrails.shift();

// --- Police update ---
for(let i=police.length-1;i>=0;i--){
let cop=police[i];
const targetAngle=Math.atan2(player.y-cop.y,player.x-cop.x);
let angleDiff=wrapAngle(targetAngle-cop.angle);
const turnDirection=Math.sign(angleDiff);
cop.angle+=Math.min(Math.abs(angleDiff),cop.turnSpeed*deltaTime)*turnDirection;
cop.x+=Math.cos(cop.angle)*cop.speed*deltaTime;
cop.y+=Math.sin(cop.angle)*cop.speed*deltaTime;
}

// --- Spawn cops ---
spawnTimer-=deltaTime;
if(spawnTimer<=0){spawnPolice();spawnTimer=spawnInterval;if(spawnInterval>1)spawnInterval*=0.95;}

// --- Collisions: cops & cops ---
for (let i = police.length - 1; i >= 0; i--) {
    for (let j = i - 1; j >= 0; j--) {
        if (i >= police.length || j >= police.length) continue; 
        let cop1 = police[i];
        let cop2 = police[j];
        
        if (gameTime - cop1.spawnTime < COP_SPAWN_INVULNERABILITY || gameTime - cop2.spawnTime < COP_SPAWN_INVULNERABILITY) {
            continue;
        }

        if (getDistance(cop1.x, cop1.y, cop2.x, cop2.y) < cop1.radius + cop2.radius) {
            createExplosion(cop1.x, cop1.y, 15);
            createExplosion(cop2.x, cop2.y, 15);
            police.splice(i, 1);
            police.splice(j, 1);
            score += 200;
            break; 
        }
    }
}

// --- Collisions: player & cops ---
for(let i=police.length-1;i>=0;i--){
let cop=police[i];

if (gameTime - cop.spawnTime < COP_SPAWN_INVULNERABILITY) {
    continue;
}

if(getDistance(player.x,player.y,cop.x,cop.y)<player.radius+cop.radius){
createExplosion(player.x,player.y,30);
createExplosion(cop.x,cop.y,15);
police.splice(i,1);
showGameOver();
}
}

// --- Particles update ---
for(let i=particles.length-1;i>=0;i--){
let p=particles[i];p.x+=p.dx*deltaTime;p.y+=p.dy*deltaTime;p.life-=deltaTime;if(p.life<=0)particles.splice(i,1);
}

// --- Handle Firing ---
if (input.fire) {
    if (performance.now() - lastShotTime > SHOT_COOLDOWN) {
        spawnBulletFromCar(player);
        lastShotTime = performance.now();
    }
}

// --- Bullets update ---
for(let i=bullets.length-1;i>=0;i--){
let b=bullets[i];
b.x+=b.vx*deltaTime;b.y+=b.vy*deltaTime;b.life-=deltaTime;
if(b.life<=0){bullets.splice(i,1);continue;}
for(let j=police.length-1;j>=0;j--){
let cop=police[j];
if(getDistance(b.x,b.y,cop.x,cop.y)<BULLET_RADIUS+cop.radius){
createExplosion(cop.x,cop.y,15);police.splice(j,1);bullets.splice(i,1);
score += 100;
break;
}}}

scoreDisplay.textContent = score;
}

function drawMiniMap() {
    const mapSize = 150;
    const mapMargin = 20;
    const mapX = canvas.width - mapSize - mapMargin;
    const mapY = mapMargin;
    const scale = mapSize / MINIMAP_SCOPE; 
    
    ctx.save();
    ctx.translate(mapX, mapY);

    ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
    ctx.strokeStyle = 'white';
    ctx.lineWidth = 2;
    ctx.fillRect(0, 0, mapSize, mapSize);
    ctx.strokeRect(0, 0, mapSize, mapSize);

    ctx.fillStyle = player.color;
    ctx.beginPath();
    ctx.arc(mapSize / 2, mapSize / 2, 3, 0, Math.PI * 2); 
    ctx.fill();

    ctx.fillStyle = '#EF4444';
    for (let cop of police) {
        const relativeX = cop.x - player.x;
        const relativeY = cop.y - player.y;

        const mapDotX = (relativeX * scale) + (mapSize / 2);
        const mapDotY = (relativeY * scale) + (mapSize / 2);

        if (gameTime - cop.spawnTime < COP_SPAWN_INVULNERABILITY) {
            ctx.globalAlpha = 0.5;
        } else {
            ctx.globalAlpha = 1.0;
        }

        if (mapDotX > 0 && mapDotX < mapSize && mapDotY > 0 && mapDotY < mapSize) {
            ctx.beginPath();
            ctx.arc(mapDotX, mapDotY, 2, 0, Math.PI * 2); 
            ctx.fill();
        }
    }
    
    ctx.restore(); 
}

// --- DRAW FUNCTION ---
function draw(){
ctx.clearRect(0,0,canvas.width,canvas.height);
// Make sure player object exists before trying to read it
if (!player || typeof player.x === 'undefined') {
    camera.x = 0;
    camera.y = 0;
} else {
    camera.x=player.x;
    camera.y=player.y;
}
ctx.save();ctx.translate(canvas.width/2-camera.x,canvas.height/2-camera.y);

// --- Draw contrails
for(let s of contrails){
    s.life-=0.02;
    ctx.save();
    ctx.translate(s.x,s.y);
    ctx.rotate(s.angle);
    ctx.fillStyle=`rgba(255,255,255,${s.life * 0.5})`; 
    ctx.fillRect(-10,-2,20,4);
    ctx.restore();
}

for(let p of particles){ctx.fillStyle=`rgba(255,165,0,${p.life/p.maxLife})`;ctx.beginPath();ctx.arc(p.x,p.y,p.size,0,Math.PI*2);ctx.fill();}
for(let b of bullets){ctx.fillStyle='yellow';ctx.beginPath();ctx.arc(b.x,b.y,BULLET_RADIUS,0,Math.PI*2);ctx.fill();}
// Only draw player if it exists
if (player && typeof player.x !== 'undefined') {
    drawJet(ctx, player);
}
for(let cop of police){ drawJet(ctx, cop); }

ctx.restore(); 

drawMiniMap();
}

// --- MAIN LOOP ---
function gameLoop(timestamp){const deltaTime=(timestamp-lastTime)/1000;lastTime=timestamp;if(gameState==='playing')update(deltaTime);draw();requestAnimationFrame(gameLoop);}

// --- INPUT ---
restartButton.addEventListener('click',resetGame);
window.addEventListener('resize',resizeCanvas);

window.addEventListener('keydown',e=>{
if(gameState==='menu')resetGame();
if(e.key==='ArrowLeft')input.left=true;
if(e.key==='ArrowRight')input.right=true;
if(e.code==='Space')input.fire=true;
});

window.addEventListener('keyup',e=>{
if(e.key==='ArrowLeft')input.left=false;
if(e.key==='ArrowRight')input.right=false;
if(e.code==='Space')input.fire=false;
});

touchLeft.addEventListener('touchstart',e=>{e.preventDefault();input.left=true;if(gameState==='menu')resetGame();},{passive:false});
touchLeft.addEventListener('touchend',e=>{e.preventDefault();input.left=false;},{passive:false});
touchRight.addEventListener('touchstart',e=>{e.preventDefault();input.right=true;if(gameState==='menu')resetGame();},{passive:false});
touchRight.addEventListener('touchend',e=>{e.preventDefault();input.right=false;},{passive:false});

// --- BULLETS ---
function spawnBulletFromCar(car){
const noseOffset=(car.height/2)+6;
const bx=car.x+Math.cos(car.angle)*noseOffset;
const by=car.y+Math.sin(car.angle)*noseOffset;
bullets.push({x:bx,y:by,vx:Math.cos(car.angle)*BULLET_SPEED,vy:Math.sin(car.angle)*BULLET_SPEED,life:2.5,radius:BULLET_RADIUS});
}

// --- START ---
resizeCanvas();lastTime=performance.now();requestAnimationFrame(gameLoop);
</script>
</body>
</html>
