<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Tax Evasion</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0;}
html,body{width:100%;height:100%;overflow:hidden;font-family:'Inter',sans-serif;color:white;background-color:#111827;}
#gameCanvas{display:block;background-color:#374151;position:absolute;top:0;left:0;z-index:1;}
.ui-container{position:absolute;top:0;left:0;width:100%;height:100%;z-index:2;pointer-events:none;display:flex;flex-direction:column;justify-content:space-between;align-items:center;}
#scoreDisplay{font-size:3rem;font-weight:900;margin-top:2rem;text-shadow:0 0 10px rgba(0,0,0,0.5);}
#messageOverlay{font-size:1.5rem;font-weight:700;text-align:center;animation:pulse 2s infinite;}
@keyframes pulse{0%{opacity:1;transform:scale(1);}50%{opacity:0.7;transform:scale(1.05);}100%{opacity:1;transform:scale(1);}}
#gameOverModal{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);z-index:3;background-color:#1F2937;padding:2.5rem;border-radius:1rem;box-shadow:0 10px 30px rgba(0,0,0,0.4);text-align:center;display:none;pointer-events:auto;}
#gameOverModal h1{font-size:2.5rem;font-weight:900;margin-bottom:0.5rem;}
#gameOverModal p{font-size:1.2rem;margin-bottom:2rem;color:#D1D5DB;}
#restartButton{font-family:'Inter',sans-serif;background:#3B82F6;color:white;border:none;padding:1rem 2rem;border-radius:0.5rem;font-size:1.2rem;font-weight:700;cursor:pointer;transition:all 0.2s ease;box-shadow:0 4px 15px rgba(59,130,246,0.3);}
#restartButton:hover{background:#2563EB;transform:translateY(-2px);}
.touch-zone{position:absolute;top:0;width:50%;height:100%;z-index:1;}
#touchLeft{left:0;}
#touchRight{right:0;}
</style>
</head>
<body>
<canvas id="gameCanvas"></canvas>
<div class="touch-zone" id="touchLeft"></div>
<div class="touch-zone" id="touchRight"></div>
<div class="ui-container">
<div id="scoreDisplay">0</div>
<div id="messageOverlay">Tap Left/Right to Steer<br>Press any key to Start</div>
</div>
<div id="gameOverModal">
<h1>Game Over</h1>
<p>Your final score is: <span id="finalScore">0</span></p>
<p>High Score: <span id="bestScore">0</span></p>
<button id="restartButton">Retry</button>
</div>
<script>
const canvas=document.getElementById('gameCanvas');
const ctx=canvas.getContext('2d');
const scoreDisplay=document.getElementById('scoreDisplay');
const messageOverlay=document.getElementById('messageOverlay');
const gameOverModal=document.getElementById('gameOverModal');
const finalScoreDisplay=document.getElementById('finalScore');
const bestScoreDisplay=document.getElementById('bestScore');
const restartButton=document.getElementById('restartButton');
const touchLeft=document.getElementById('touchLeft');
const touchRight=document.getElementById('touchRight');

let gameState='menu';
let score=0,lastTime=0,gameTime=0;
const camera={x:0,y:0};
const worldBounds={width:5000,height:5000};
const worldGridSize=100;
const PLAYER_SPEED=150,PLAYER_TURN_SPEED=3.5;
const CAR_WIDTH=20,CAR_HEIGHT=40,CAR_RADIUS=20;
const COP_SPEED=400
  ,COP_TURN_SPEED=2.0;
const MAX_COPS_ON_SCREEN=5;
let spawnTimer=0,spawnInterval=5;

const input={left:false,right:false};
let player={},police=[],particles=[],skidMarks=[],bullets=[];
let ammo=100,MAX_AMMO=100,RELOAD_COOLDOWN=10,reloadTimer=0,isReloading=false;
let lastShotTime=0,SHOT_COOLDOWN=100,BULLET_SPEED=1500,BULLET_RADIUS=5;
let highScore=Number(localStorage.getItem('pp_highscore')||0);

function resizeCanvas(){canvas.width=window.innerWidth;canvas.height=window.innerHeight;}
function rand(min,max){return Math.random()*(max-min)+min;}
function getDistance(x1,y1,x2,y2){return Math.hypot(x2-x1,y2-y1);}
function wrapAngle(angle){return(angle+Math.PI)%(Math.PI*2)-Math.PI;}
function createCar(x,y,angle,speed,turnSpeed,color,type){return{x,y,angle,speed,turnSpeed,color,type,width:CAR_WIDTH,height:CAR_HEIGHT,radius:CAR_RADIUS,velX:0,velY:0};}

function resetGame(){
player=createCar(worldBounds.width/2,worldBounds.height/2,-Math.PI/2,PLAYER_SPEED,PLAYER_TURN_SPEED,'#3B82F6','player');
police=[];particles=[];skidMarks=[];bullets=[];
score=0;gameTime=0;spawnTimer=2;spawnInterval=5;ammo=MAX_AMMO;reloadTimer=0;isReloading=false;
gameState='playing';
gameOverModal.style.display='none';
messageOverlay.style.display='none';
scoreDisplay.style.display='block';
}

function spawnPolice(){
if(police.length>=MAX_COPS_ON_SCREEN)return;
const spawnAngle=Math.random()*Math.PI*2;
const spawnDist=Math.max(canvas.width,canvas.height)*0.7;
const x=player.x+Math.cos(spawnAngle)*spawnDist;
const y=player.y+Math.sin(spawnAngle)*spawnDist;
const angle=Math.atan2(player.y-y,player.x-x);
police.push(createCar(x,y,angle,COP_SPEED,COP_TURN_SPEED,'#EF4444','police'));
}

function createExplosion(x,y,count){
for(let i=0;i<count;i++){const angle=Math.random()*Math.PI*2;const speed=rand(50,200);const life=rand(0.5,1.5);particles.push({x,y,dx:Math.cos(angle)*speed,dy:Math.sin(angle)*speed,life,maxLife:life,size:rand(2,5)});}
}

function showGameOver(){
gameState='gameOver';
scoreDisplay.style.display='none';
messageOverlay.style.display='none';
finalScoreDisplay.textContent=Math.floor(score*10);
if(score*10>highScore){highScore=Math.floor(score*10);localStorage.setItem('pp_highscore',highScore);}
bestScoreDisplay.textContent=highScore;
gameOverModal.style.display='block';
}

// --- MAIN UPDATE FUNCTION ---
function update(deltaTime){
if(!deltaTime||isNaN(deltaTime))return;
if(gameState!=='playing')return;

// --- Score & Time ---
gameTime+=deltaTime;
score+=deltaTime;
scoreDisplay.textContent=Math.floor(score*10);

// --- Player input & drift ---
if(input.left)player.angle-=player.turnSpeed*deltaTime;
if(input.right)player.angle+=player.turnSpeed*deltaTime;
player.velX+=Math.cos(player.angle)*player.speed*deltaTime*0.5;
player.velY+=Math.sin(player.angle)*player.speed*deltaTime*0.5;
player.velX*=0.92;
player.velY*=0.92;
player.x+=player.velX;
player.y+=player.velY;

// --- Skid marks ---
if(input.left||input.right)skidMarks.push({x:player.x,y:player.y,angle:player.angle,life:1});
if(skidMarks.length>300)skidMarks.shift();

// --- Police update ---
for(let i=police.length-1;i>=0;i--){
let cop=police[i];
const targetAngle=Math.atan2(player.y-cop.y,player.x-cop.x);
let angleDiff=wrapAngle(targetAngle-cop.angle);
const turnDirection=Math.sign(angleDiff);
cop.angle+=Math.min(Math.abs(angleDiff),cop.turnSpeed*deltaTime)*turnDirection;
cop.x+=Math.cos(cop.angle)*cop.speed*deltaTime;
cop.y+=Math.sin(cop.angle)*cop.speed*deltaTime;
}

// --- Spawn cops ---
spawnTimer-=deltaTime;
if(spawnTimer<=0){spawnPolice();spawnTimer=spawnInterval;if(spawnInterval>1)spawnInterval*=0.95;}

// --- Collisions: player & cops ---
for(let i=police.length-1;i>=0;i--){
let cop=police[i];
if(getDistance(player.x,player.y,cop.x,cop.y)<player.radius+cop.radius){
createExplosion(player.x,player.y,30);
createExplosion(cop.x,cop.y,15);
police.splice(i,1);
showGameOver();
}
}

// --- Particles update ---
for(let i=particles.length-1;i>=0;i--){
let p=particles[i];p.x+=p.dx*deltaTime;p.y+=p.dy*deltaTime;p.life-=deltaTime;if(p.life<=0)particles.splice(i,1);
}

// --- Bullets update ---
for(let i=bullets.length-1;i>=0;i--){
let b=bullets[i];
b.x+=b.vx*deltaTime;b.y+=b.vy*deltaTime;b.life-=deltaTime;
if(b.life<=0){bullets.splice(i,1);continue;}
for(let j=police.length-1;j>=0;j--){
let cop=police[j];
if(getDistance(b.x,b.y,cop.x,cop.y)<BULLET_RADIUS+cop.radius){
createExplosion(cop.x,cop.y,15);police.splice(j,1);bullets.splice(i,1);break;
}}}

// --- Ammo reload ---
if(isReloading){reloadTimer-=deltaTime;if(reloadTimer<=0){ammo=MAX_AMMO;isReloading=false;}}
}

// --- DRAW FUNCTION (unchanged) ---
function draw(){
ctx.clearRect(0,0,canvas.width,canvas.height);
camera.x=player.x||0;
camera.y=player.y||0;
ctx.save();ctx.translate(canvas.width/2-camera.x,canvas.height/2-camera.y);
ctx.strokeStyle='#4B5563';ctx.lineWidth=1;
const camLeft=camera.x-canvas.width/2,camRight=camera.x+canvas.width/2;
const camTop=camera.y-canvas.height/2,camBottom=camera.y+canvas.height/2;
const startX=Math.floor(camLeft/worldGridSize)*worldGridSize,endX=Math.ceil(camRight/worldGridSize)*worldGridSize;
const startY=Math.floor(camTop/worldGridSize)*worldGridSize,endY=Math.ceil(camBottom/worldGridSize)*worldGridSize;
for(let x=startX;x<=endX;x+=worldGridSize){ctx.beginPath();ctx.moveTo(x,startY);ctx.lineTo(x,endY);ctx.stroke();}
for(let y=startY;y<=endY;y+=worldGridSize){ctx.beginPath();ctx.moveTo(startX,y);ctx.lineTo(endX,y);ctx.stroke();}
for(let s of skidMarks){s.life-=0.02;ctx.save();ctx.translate(s.x,s.y);ctx.rotate(s.angle);ctx.fillStyle=`rgba(0,0,0,${s.life})`;ctx.fillRect(-10,-2,20,4);ctx.restore();}
for(let p of particles){ctx.fillStyle=`rgba(255,165,0,${p.life/p.maxLife})`;ctx.beginPath();ctx.arc(p.x,p.y,p.size,0,Math.PI*2);ctx.fill();}
for(let b of bullets){ctx.fillStyle='yellow';ctx.beginPath();ctx.arc(b.x,b.y,BULLET_RADIUS,0,Math.PI*2);ctx.fill();}
ctx.save();ctx.translate(player.x,player.y);ctx.rotate(player.angle);ctx.fillStyle=player.color;ctx.fillRect(-player.height/2,-player.width/2,player.height,player.width);ctx.restore();
ctx.fillStyle='red';for(let cop of police){ctx.save();ctx.translate(cop.x,cop.y);ctx.rotate(cop.angle);ctx.fillRect(-cop.height/2,-cop.width/2,cop.height,cop.width);ctx.restore();}
ctx.restore();
}

// --- MAIN LOOP ---
function gameLoop(timestamp){const deltaTime=(timestamp-lastTime)/1000;lastTime=timestamp;if(gameState==='playing')update(deltaTime);draw();requestAnimationFrame(gameLoop);}

// --- INPUT ---
restartButton.addEventListener('click',resetGame);
window.addEventListener('resize',resizeCanvas);
window.addEventListener('keydown',e=>{
if(gameState==='menu')resetGame();
if(e.key==='ArrowLeft')input.left=true;
if(e.key==='ArrowRight')input.right=true;
if(e.code==='Space'){
if(!isReloading&&ammo>0&&performance.now()-lastShotTime>SHOT_COOLDOWN){
spawnBulletFromCar(player);
ammo--;lastShotTime=performance.now();
if(ammo<=0){isReloading=true;reloadTimer=RELOAD_COOLDOWN;}
}}});
window.addEventListener('keyup',e=>{if(e.key==='ArrowLeft')input.left=false;if(e.key==='ArrowRight')input.right=false;});
touchLeft.addEventListener('touchstart',e=>{e.preventDefault();input.left=true;if(gameState==='menu')resetGame();},{passive:false});
touchLeft.addEventListener('touchend',e=>{e.preventDefault();input.left=false;},{passive:false});
touchRight.addEventListener('touchstart',e=>{e.preventDefault();input.right=true;if(gameState==='menu')resetGame();},{passive:false});
touchRight.addEventListener('touchend',e=>{e.preventDefault();input.right=false;},{passive:false});

// --- BULLETS ---
function spawnBulletFromCar(car){
const noseOffset=(car.height/2)+6;
const bx=car.x+Math.cos(car.angle)*noseOffset;
const by=car.y+Math.sin(car.angle)*noseOffset;
bullets.push({x:bx,y:by,vx:Math.cos(car.angle)*BULLET_SPEED,vy:Math.sin(car.angle)*BULLET_SPEED,life:2.5,radius:BULLET_RADIUS});
}

// --- START ---
resizeCanvas();lastTime=performance.now();requestAnimationFrame(gameLoop);
</script>
</body>
</html>
