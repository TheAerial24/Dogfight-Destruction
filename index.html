<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dogfight Destruction v1.0</title>
    
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #333;
            color: #fff;
            font-family: Arial, sans-serif;
            text-align: center;
        }

        canvas {
            background-color: #000;
            display: block;
            margin: 0 auto;
            cursor: pointer; 
        }

        h1, p {
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas" width="400" height="600"></canvas>
    
    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        let player = {
            x: canvas.width / 2 - 25,
            y: canvas.height - 60,
            width: 50,
            height: 50,
            speed: 5,
            dx: 0
        };

        let bullets = [];
        let enemies = [];
        let keys = {};
        let score = 0;
        let highScore = localStorage.getItem('dogfightHighScore') || 0;
        let gameOver = false;
        let gameStarted = false;
        let gamePaused = false;
        let enemySpeed = 2;
        let enemySpawnRate = 2000; // in ms
        let lastEnemySpawn = 0;
        let cheatingDetected = false;
        let lastTime = 0;
        let frameCount = 0;
        let fps = 0;

        // --- NEW ACHIEVEMENT VARIABLES ---
        let achievements = {};
        let totalKills = 0;
        let distanceTravelled = 0;
        let showingAchievements = false;
        // --- END NEW ACHIEVEMENT VARIABLES ---

        const playerImg = new Image();
        playerImg.src = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAAsQAAALEBGBJ04gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAADdSURBVEiJrdW9LkMBGIDh909sYCSKaGxs/G9sBFtFEJsYJDbxL2JjGz8g3YAdhQy7C04kznlOS5KRJOfpbpLzAYvAo3bARfAJfGGKAEYtB1yARWAU2Kg2YJgVuATeAAN2gAWwBLR6DbBKYf6FNQB9AK/AXvAAXARGS1P0AKYJbJHvAWeAFaBDEdgR+AfYBNY0xYEVMI1sEfgM+KsaAy/AJjCGrAfYBN5TYBsoAbsBq8AacAJ8BXbVglsAGWAOuAK+M09sPXYvA3aBnTAN7BUP7hfsisAh8CNn5wBNAk78AfuXCQAAAABJRU5ErkJggg==';

        const enemyImg = new Image();
        enemyImg.src = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAAsQAAALEBGBJ04gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAACVSURBVEiJ7ZYxCsAwDAS/0Puvmy4eILg46SAepKuHoIPgYFkQFDqJ/xYQBIrMv9iXhKQPjJLgCPQAbYBW0AOE/RXwAbaAWmALaAAp8EuwARSAFpACusAOUAUmOflpASeANtAD6ABtYBaQI9gBdAG6QAvg/QCzOflnAPwA7YBYwA7wA6wBSoL/gAfw03Opn/YPSvQBRu4Cy2YmAgIAAAAASUVORK5CYII=';

        document.addEventListener('keydown', (e) => {
            if (!gameStarted && !cheatingDetected) {
                gameStarted = true;
                resetGame();
                gameLoop(0);
            }
            keys[e.key] = true;

            if (e.key === ' ' && !gameOver && !gamePaused && gameStarted) {
                shoot();
            }

            if (e.key.toLowerCase() === 'p' && gameStarted && !gameOver) {
                gamePaused = !gamePaused;
                if (!gamePaused) {
                    requestAnimationFrame(gameLoop);
                }
            }
        });

        document.addEventListener('keyup', (e) => {
            keys[e.key] = false;
        });

        // --- NEW CLICK HANDLER ---
        canvas.addEventListener('click', handleCanvasClick);

        function handleCanvasClick(e) {
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;

            if (showingAchievements) {
                // Check for "Close" button click (top right of modal)
                if (mouseX > canvas.width - 100 - 10 && mouseX < canvas.width - 50 + 10 &&
                    mouseY > 60 - 10 && mouseY < 90 + 5) {
                    showingAchievements = false;
                }
            } else if (gameOver && !cheatingDetected) {
                // Check for "Retry" button click
                if (mouseX > canvas.width / 2 - 50 && mouseX < canvas.width / 2 + 50 &&
                    mouseY > canvas.height / 2 + 60 && mouseY < canvas.height / 2 + 90) {
                    resetGame();
                }
                
                // Check for "Achievements" button click (top left)
                if (mouseX > 10 && mouseX < 160 && mouseY > 10 && mouseY < 50) {
                    showingAchievements = true;
                }
            }
        }
        // --- END NEW CLICK HANDLER ---


        function shoot() {
            const bullet = {
                x: player.x + player.width / 2 - 2.5,
                y: player.y,
                width: 5,
                height: 10,
                speed: 10
            };
            bullets.push(bullet);
        }

        function spawnEnemy(timestamp) {
            if (gameOver || gamePaused) return;

            if (timestamp - lastEnemySpawn > enemySpawnRate) {
                const size = 30;
                const x = Math.random() * (canvas.width - size);
                const y = -size;
                enemies.push({ x, y, width: size, height: size });
                lastEnemySpawn = timestamp;

                // Increase difficulty
                enemySpeed += 0.05;
                if (enemySpawnRate > 500) {
                    enemySpawnRate -= 10;
                }
            }
        }

        function detectCollision(a, b) {
            return a.x < b.x + b.width &&
                   a.x + a.width > b.x &&
                   a.y < b.y + b.height &&
                   a.y + a.height > b.y;
        }

        function resetGame() {
            player.x = canvas.width / 2 - 25;
            player.y = canvas.height - 60;
            bullets = [];
            enemies = [];
            score = 0;
            gameOver = false;
            gameStarted = true;
            gamePaused = false;
            enemySpeed = 2;
            enemySpawnRate = 2000;
            lastEnemySpawn = 0;
            // --- NEW ACHIEVEMENT RESETS ---
            totalKills = 0;
            distanceTravelled = 0;
            showingAchievements = false;
            // --- END NEW ACHIEVEMENT RESETS ---
        }

        function detectCheating() {
            if (score > 50000 && enemySpeed < 3) {
                cheatingDetected = true;
                gameOver = true;
                gameStarted = false;
                // --- NEW ---
                unlockAchievement('cheater');
            }
        }

        function drawAntiCheatScreen() {
            ctx.fillStyle = '#f00';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#fff';
            ctx.font = '30px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Cheating Detected!', canvas.width / 2, canvas.height / 2 - 40);
            ctx.font = '20px Arial';
            ctx.fillText('Nice try, buddy.', canvas.width / 2, canvas.height / 2);
            ctx.fillText(`Final Score: ${score}`, canvas.width / 2, canvas.height / 2 + 40);
            
            // --- NEW ---
            // Trigger "No More" check just in case this was the last one
            checkAllAchievements(); 
        }

        function drawStartScreen() {
            ctx.fillStyle = '#fff';
            ctx.font = '20px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Tap/Press Left/Right to Steer', canvas.width / 2, canvas.height / 2 - 20);
            ctx.fillText('Spacebar to Shoot', canvas.width / 2, canvas.height / 2 + 10);
            ctx.font = '24px Arial';
            ctx.fillText('Press any key to Start', canvas.width / 2, canvas.height / 2 + 60);
            
            ctx.font = '16px Arial';
            ctx.fillText('Press P to Pause', canvas.width / 2, canvas.height - 30);
        }

        function drawGameOver() {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.fillStyle = '#fff';
            ctx.font = '40px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Game Over', canvas.width / 2, canvas.height / 2 - 40);

            ctx.font = '24px Arial';
            ctx.fillText(`Your final score is: ${score}`, canvas.width / 2, canvas.height / 2 + 10);
            ctx.fillText(`High Score: ${highScore}`, canvas.width / 2, canvas.height / 2 + 40);

            // Draw Retry Button
            ctx.fillStyle = '#4CAF50';
            ctx.fillRect(canvas.width / 2 - 50, canvas.height / 2 + 60, 100, 30);
            ctx.fillStyle = '#fff';
            ctx.font = '20px Arial';
            ctx.fillText('Retry', canvas.width / 2, canvas.height / 2 + 82);
            
            // --- NEW ACHIEVEMENT BUTTON ---
            ctx.fillStyle = '#007BFF';
            ctx.fillRect(10, 10, 150, 40);
            ctx.fillStyle = '#fff';
            ctx.font = '18px Arial';
            ctx.textAlign = 'left';
            ctx.fillText('Achievements', 20, 37);
            ctx.textAlign = 'center'; // Reset alignment
            // --- END NEW ACHIEVEMENT BUTTON ---
        }

        function drawPauseScreen() {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#fff';
            ctx.font = '40px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Paused', canvas.width / 2, canvas.height / 2);
        }

        function drawScore() {
            ctx.fillStyle = '#fff';
            ctx.font = '20px Arial';
            ctx.textAlign = 'left';
            ctx.fillText(`Score: ${score}`, 10, 20);
            ctx.fillText(`High Score: ${highScore}`, 10, 45);
        }

        function drawFPS() {
            ctx.fillStyle = '#fff';
            ctx.font = '16px Arial';
            ctx.textAlign = 'right';
            ctx.fillText(`FPS: ${fps}`, canvas.width - 10, 20);
        }

        function update(timestamp) {
            if (gameOver) {
                if (score > highScore) {
                    highScore = score;
                    localStorage.setItem('dogfightHighScore', highScore);
                }
                
                // --- NEW ACHIEVEMENT CHECKS ON GAME OVER ---
                if (score > 10000) {
                    unlockAchievement('highScore');
                }
                // Check if this game over completed all achievements
                checkAllAchievements();
                // --- END NEW ACHIEVEMENT CHECKS ---
                return;
            }

            if (gamePaused) {
                return;
            }

            if (!gameStarted) {
                return;
            }
            
            // --- NEW ---
            detectCheating();
            if (cheatingDetected) {
                return;
            }

            // Player movement
            player.dx = 0;
            if (keys['ArrowLeft'] || keys['a']) {
                player.dx = -player.speed;
            }
            if (keys['ArrowRight'] || keys['d']) {
                player.dx = player.speed;
            }
            player.x += player.dx;

            // Keep player in bounds
            if (player.x < 0) player.x = 0;
            if (player.x + player.width > canvas.width) player.x = canvas.width - player.width;

            // --- NEW: Track distance ---
            distanceTravelled += enemySpeed;
            if (distanceTravelled >= 5000) {
                unlockAchievement('traveller');
            }
            // --- END NEW ---

            // Update bullets
            for (let i = bullets.length - 1; i >= 0; i--) {
                bullets[i].y -= bullets[i].speed;
                if (bullets[i].y < 0) {
                    bullets.splice(i, 1);
                }
            }

            // Update enemies
            for (let i = enemies.length - 1; i >= 0; i--) {
                enemies[i].y += enemySpeed;
                if (enemies[i].y > canvas.height) {
                    enemies.splice(i, 1);
                }
            }

            // Collision detection: Bullets and Enemies
            for (let i = bullets.length - 1; i >= 0; i--) {
                for (let j = enemies.length - 1; j >= 0; j--) {
                    if (detectCollision(bullets[i], enemies[j])) {
                        bullets.splice(i, 1);
                        enemies.splice(j, 1);
                        score += 100;
                        
                        // --- NEW ACHIEVEMENT CHECKS ---
                        totalKills++;
                        unlockAchievement('firstBlood');
                        if (totalKills >= 50) {
                            unlockAchievement('50kills');
                        }
                        // --- END NEW ---
                        break; 
                    }
                }
            }
            
            // --- NEW: Collision detection: Enemy and Enemy ---
            for (let i = 0; i < enemies.length; i++) {
                for (let j = i + 1; j < enemies.length; j++) {
                    if (detectCollision(enemies[i], enemies[j])) {
                        // Remove both enemies
                        enemies.splice(j, 1); // Remove j first (higher index)
                        enemies.splice(i, 1);

                        // --- NEW ACHIEVEMENT CHECKS ---
                        unlockAchievement('evasion');
                        
                        totalKills += 2; // Both are "killed"
                        unlockAchievement('firstBlood'); // Counts as first blood
                        if (totalKills >= 50) {
                            unlockAchievement('50kills');
                        }
                        // --- END NEW ---
                        
                        i--; // Adjust outer loop index
                        break; // Exit inner loop
                    }
                }
            }
            // --- END NEW ---


            // Collision detection: Player and Enemies
            for (let i = enemies.length - 1; i >= 0; i--) {
                if (detectCollision(player, enemies[i])) {
                    gameOver = true;
                    break;
                }
            }

            spawnEnemy(timestamp);
        }

        function draw() {
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (cheatingDetected) {
                drawAntiCheatScreen();
                return;
            }

            // Draw player
            ctx.drawImage(playerImg, player.x, player.y, player.width, player.height);

            // Draw bullets
            ctx.fillStyle = '#f00';
            bullets.forEach(bullet => {
                ctx.fillRect(bullet.x, bullet.y, bullet.width, bullet.height);
            });

            // Draw enemies
            enemies.forEach(enemy => {
                ctx.drawImage(enemyImg, enemy.x, enemy.y, enemy.width, enemy.height);
            });

            if (!gameStarted) {
                drawStartScreen();
            } else if (gameOver) {
                drawGameOver();
            } else if (gamePaused) {
                drawPauseScreen();
            } else {
                drawScore();
                drawFPS();
            }
            
            // --- NEW: Draw achievement modal ---
            if (showingAchievements) {
                drawAchievements();
            }
            // --- END NEW ---
        }

        function gameLoop(timestamp) {
            let deltaTime = timestamp - lastTime;
            lastTime = timestamp;
            frameCount++;
            if (timestamp % 1000 < deltaTime) {
                fps = frameCount;
                frameCount = 0;
            }

            update(timestamp);
            draw();

            if (!gameOver && !gamePaused) {
                requestAnimationFrame(gameLoop);
            } else if (gameOver && cheatingDetected) {
                // Stop loop if cheating is detected
                return;
            }
        }

        // --- NEW ACHIEVEMENT FUNCTIONS ---

        function initializeAchievements() {
            const defaultAchievements = {
                'firstBlood': { name: 'First Blood', description: 'Destroy your first enemy.', unlocked: false },
                'evasion': { name: 'Evasion', description: 'Have 2 enemies collide with one another.', unlocked: false },
                'traveller': { name: 'Traveller', description: 'Travel 5000 pixels.', unlocked: false },
                '50kills': { name: '50 Kills', description: 'Get 50 total kills.', unlocked: false },
                'cheater': { name: 'Cheater', description: 'Get caught by the anticheat.', unlocked: false },
                'highScore': { name: 'High Score', description: 'Get a score over 10000.', unlocked: false },
                'noMore': { name: 'No More', description: 'Unlock all other achievements.', unlocked: false }
            };
            
            achievements = defaultAchievements;
        }

        function loadAchievements() {
            const saved = localStorage.getItem('dogfightAchievements');
            if (saved) {
                achievements = JSON.parse(saved);
                // This ensures if we add new achievements later, they get added
                initializeAchievements(); 
                let savedObj = JSON.parse(saved);
                for (let key in achievements) {
                    if (savedObj[key]) {
                        achievements[key].unlocked = savedObj[key].unlocked;
                    }
                }
            } else {
                initializeAchievements();
            }
        }

        function saveAchievements() {
            localStorage.setItem('dogfightAchievements', JSON.stringify(achievements));
        }

        function unlockAchievement(id) {
            if (achievements[id] && !achievements[id].unlocked) {
                achievements[id].unlocked = true;
                
                // Special check for 'noMore'
                if (id !== 'noMore') {
                    checkAllAchievements(); // Check if this unlock triggered 'noMore'
                }
                
                saveAchievements();
            }
        }

        function checkAllAchievements() {
            // Don't check if 'noMore' is already unlocked
            if (achievements.noMore.unlocked) return;

            let allOthersUnlocked = true;
            for (const key in achievements) {
                if (key !== 'noMore' && !achievements[key].unlocked) {
                    allOthersUnlocked = false;
                    break;
                }
            }

            if (allOthersUnlocked) {
                // Manually unlock 'noMore' to avoid recursion
                achievements.noMore.unlocked = true;
            }
        }

        function drawAchievements() {
            // Background overlay
            ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Modal box
            ctx.fillStyle = '#222';
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 2;
            ctx.fillRect(50, 50, canvas.width - 100, canvas.height - 100);
            ctx.strokeRect(50, 50, canvas.width - 100, canvas.height - 100);

            // Title
            ctx.fillStyle = '#fff';
            ctx.font = '28px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Achievements', canvas.width / 2, 90);

            // Close button
            ctx.fillStyle = '#ccc';
            ctx.fillRect(canvas.width - 100, 60, 40, 30);
            ctx.fillStyle = '#000';
            ctx.font = '20px Arial';
            ctx.fillText('X', canvas.width - 80, 82);

            // List achievements
            let yPos = 140;
            for (const key in achievements) {
                const ach = achievements[key];
                
                if (ach.unlocked) {
                    ctx.fillStyle = '#4CAF50'; // Green for unlocked
                } else {
                    ctx.fillStyle = '#777'; // Grey for locked
                }
                
                ctx.textAlign = 'left';
                ctx.font = '20px Arial';
                ctx.fillText(ach.name, 70, yPos);
                
                if (ach.unlocked) {
                    ctx.fillStyle = '#ccc';
                } else {
                    ctx.fillStyle = '#555';
                }
                ctx.font = '14px Arial';
                ctx.fillText(ach.description, 70, yPos + 20);
                
                yPos += 60;
            }
            ctx.textAlign = 'center'; // Reset alignment
        }

        // --- END NEW ACHIEVEMENT FUNCTIONS ---


        // Initial call to start the screen
        loadAchievements(); // --- NEW ---
        draw();
    </script>
</body>
</html>
